#!/bin/bash

set -e

echo "ğŸš€ Podly Lambda Build & Deploy Script"
echo "======================================"

# ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ç¢ºèª
if [ ! -f "main.tf" ]; then
    echo "âŒ main.tf not found. Please run this script from podly-tr directory."
    exit 1
fi

# Lambdaé–¢æ•°ã®ãƒ“ãƒ«ãƒ‰
echo "ğŸ“¦ Building Lambda functions..."
cd ../podly-lambda

# ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install

# ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
npm run build

echo "âœ… Lambda functions built successfully"

# Terraformãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«æˆ»ã‚‹
cd ../podly-tr

# terraform.tfvarsã®å­˜åœ¨ç¢ºèª
if [ ! -f "terraform.tfvars" ]; then
    echo "âŒ terraform.tfvars not found. Please create it from terraform.tfvars.example"
    exit 1
fi

# Lambdaé–¢æ•°ã®ãƒãƒƒã‚·ãƒ¥ã‚’è¨ˆç®—ã—ã¦æ›´æ–°
echo "ğŸ” Calculating Lambda function hashes..."

# create-script.zipã®ãƒãƒƒã‚·ãƒ¥ã‚’è¨ˆç®—
if [ -f "../podly-lambda/dist/create-script.zip" ]; then
    if command -v sha256sum &> /dev/null; then
        CREATE_SCRIPT_HASH=$(sha256sum "../podly-lambda/dist/create-script.zip" | cut -d' ' -f1)
    else
        CREATE_SCRIPT_HASH=$(shasum -a 256 "../podly-lambda/dist/create-script.zip" | cut -d' ' -f1)
    fi
    echo "ğŸ“¦ create-script.zip hash: $CREATE_SCRIPT_HASH"
else
    echo "âŒ create-script.zip not found"
    exit 1
fi

# create-preview-audio.zipã®ãƒãƒƒã‚·ãƒ¥ã‚’è¨ˆç®—
if [ -f "../podly-lambda/dist/create-preview-audio.zip" ]; then
    if command -v sha256sum &> /dev/null; then
        CREATE_PREVIEW_AUDIO_HASH=$(sha256sum "../podly-lambda/dist/create-preview-audio.zip" | cut -d' ' -f1)
    else
        CREATE_PREVIEW_AUDIO_HASH=$(shasum -a 256 "../podly-lambda/dist/create-preview-audio.zip" | cut -d' ' -f1)
    fi
    echo "ğŸ“¦ create-preview-audio.zip hash: $CREATE_PREVIEW_AUDIO_HASH"
else
    echo "âŒ create-preview-audio.zip not found"
    exit 1
fi

# terraform.tfvarsãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°
echo "ğŸ“ Updating terraform.tfvars with new hashes..."
cp terraform.tfvars terraform.tfvars.backup
# æ–°ã—ã„terraform.tfvarsãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
cat > terraform.tfvars << EOF
# AWS Configuration
aws_region = "ap-northeast-1"

# Project Configuration
project_name = "podly"
environment  = "dev"


# Lambda Packages (auto-generated by build script)
lambda_packages = {
  create_script = {
    filename         = "../podly-lambda/dist/create-script.zip"
    source_code_hash = "$CREATE_SCRIPT_HASH"
  }
  create_preview_audio = {
    filename         = "../podly-lambda/dist/create-preview-audio.zip"
    source_code_hash = "$CREATE_PREVIEW_AUDIO_HASH"
  }
}

# CORS Configuration
cors_allow_origins = ["*"]
cors_allow_methods = ["GET", "POST", "OPTIONS"]
cors_allow_headers = ["Content-Type", "X-Amz-Date", "Authorization", "X-Api-Key", "X-Amz-Security-Token"]
EOF

echo "âœ… terraform.tfvars updated successfully"


# FFmpeg Layerã®ç¢ºèª
if [ ! -f "ffmpeg-layer.zip" ]; then
    echo "âš ï¸  ffmpeg-layer.zip not found. Downloading..."
    # ä¾‹: å…¬é–‹ã•ã‚Œã¦ã„ã‚‹Layerã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆå®Ÿéš›ã®URLã«ç½®ãæ›ãˆã‚‹ï¼‰
    echo "Please manually download or create ffmpeg-layer.zip for your region"
    echo "You can use: https://github.com/serverlessrepo/serverlessrepo-ffmpeg-layer"
    exit 1
fi


